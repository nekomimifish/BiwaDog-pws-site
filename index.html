<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>琵琶湖风 · PWS（相对路径修正版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #heroMap{height:56vh;min-height:360px;border-radius:14px;border:1px solid #1e2a3b}
  </style>
</head>
<body>
  <main>
    <section>
      <div id="heroMap"></div>
    </section>
    <section>
      <select id="yearSel"></select>
      <select id="monSel"></select>
      <button id="loadMonthBtn">查看本月数据（./data/YYYY-MM.csv）</button>
      <div id="status"></div>
      <pre id="preview" style="max-height:40vh;overflow:auto;border:1px solid #1e2a3b;padding:8px"></pre>
    </section>
  </main>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Leaflet 基本初始化
    const map = L.map('heroMap').setView([35.215,135.97], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);
    L.marker([35.2115,135.9770]).addTo(map).bindTooltip('Shinhama（示例）');

    // 月份选择器 + 相对路径加载 CSV
    const yearSel = document.getElementById('yearSel');
    const monSel = document.getElementById('monSel');
    const statusEl = document.getElementById('status');
    const preview = document.getElementById('preview');
    const now = new Date();
    function pad2(n){return String(n).padStart(2,'0')}
    for(let y=now.getFullYear()-5;y<=now.getFullYear()+2;y++){const o=document.createElement('option');o.value=y;o.textContent=y;if(y===now.getFullYear())o.selected=true;yearSel.appendChild(o);}
    for(let m=0;m<12;m++){const o=document.createElement('option');o.value=m;o.textContent=(m+1)+' 月';if(m===now.getMonth())o.selected=true;monSel.appendChild(o);}

    async function loadMonth(){
      const y = parseInt(yearSel.value,10);
      const m = parseInt(monSel.value,10)+1;
      const path = `./data/${y}-${pad2(m)}.csv`; // ★ 相对路径
      statusEl.textContent = `请求 ${path} ...`;
      try{
        const res = await fetch(`${path}?t=${Date.now()}`, {cache:'no-store'}); // 防缓存
        if(!res.ok) throw new Error(`HTTP ${res.status} - ${path}`);
        const text = await res.text();
        statusEl.textContent = `加载成功：${path}`;
        preview.textContent = text.slice(0, 2000); // 仅预览前 2000 字符
      }catch(err){
        statusEl.textContent = `加载失败：${err.message}（请确认该文件已上传且同源）`;
      }
    }
    document.getElementById('loadMonthBtn').addEventListener('click', loadMonth);
  </script>
</body>
</html>
