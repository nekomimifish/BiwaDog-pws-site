<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWS · 新海浜地图 + CSV风速数据</title>

  <!-- Leaflet & PapaParse：从 CDN 加载 -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0b1625;
      --muted: #5b6b82;
      --panel: #ffffff;
      --grid: #e5e9f2;
      --header: #f4f6fb;
      --accent: #1677ff;
      --hover: #eef4ff;
    }
    .dark {
      --bg: #0b1016;
      --text: #ecf2ff;
      --muted: #9fb1cc;
      --panel: #101822;
      --grid: #1f2a3a;
      --header: #0f1824;
      --accent: #3aa0ff;
      --hover: #13283f;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans JP", "Noto Sans SC", sans-serif;
    }
    header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--grid);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    select,
    input[type="text"],
    input[type="range"] {
      padding: 6px 8px;
      border: 1px solid var(--grid);
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
    }
    button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button.ghost {
      background: transparent;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .csv-link {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
      text-decoration: none;
      cursor: pointer;
    }
    .csv-link:hover {
      background: var(--hover);
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px;
    }
    /* 默认：上下结构（地图上、表格下） */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    /* 超大屏：宽 >= 2560px 时左右结构 */
    @media (min-width: 2560px) {
      .layout {
        display: grid;
        grid-template-columns: 1.05fr 1.2fr;
        align-items: start;
        gap: 20px;
      }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: 12px;
      padding: 10px;
    }
    .map-card {
      position: relative; /* 让图例可以绝对定位在卡片内部 */
    }
    #map {
      height: 60vh;
      min-height: 360px;
      border-radius: 10px;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }
    .map-controls {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }
    .map-controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .time-label {
      font-weight: 500;
    }
    #currentTime,
    #currentSpeed {
      font-family: "Consolas", "SF Mono", monospace;
    }
    .slider-wrap {
      width: 100%;
    }
    .slider-wrap input[type="range"] {
      width: 100%;
      padding: 0;
    }
    .table-wrap {
      border: 1px solid var(--grid);
      border-radius: 10px;
      overflow: auto;
      max-height: 70vh;
      background: var(--panel);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: var(--header);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th,
    td {
      border-bottom: 1px solid var(--grid);
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) td {
      background: #f9fbff;
    }
    tbody tr:hover td {
      background: var(--hover);
    }
    .spacer {
      flex: 1;
    }

    /* 图例样式 */
    .legend {
      position: absolute;
      right: 14px;
      bottom: 14px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      border: 1px solid var(--grid);
      padding: 8px 10px;
      font-size: 11px;
      color: #333;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .dark .legend {
      background: rgba(16, 24, 32, 0.9);
      color: #e0ecff;
    }
    .legend-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 2px 0;
    }
    .legend-color {
      width: 14px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
    }
    .legend-low {
      background: #2ecc71;
      border-color: #29b866;
    }
    .legend-mid {
      background: #f1c40f;
      border-color: #d0a90c;
    }
    .legend-high {
      background: #e74c3c;
      border-color: #c0392b;
    }
  </style>
</head>
<body>
  <header>
    <h1>PWS · 新海浜地图 + CSV风速数据</h1>
    <div class="toolbar">
      <label>年份</label>
      <select id="yearSel"></select>
      <label>月份</label>
      <select id="monSel"></select>
      <button id="loadBtn" class="primary">加载 ./data/YYYY-MM.csv</button>
      <a id="csvDownload" class="csv-link" href="#" download>下载当前 CSV</a>
      <span id="status" class="status"></span>
      <div class="spacer"></div>
      <button id="themeBtn" class="ghost">切换深色/浅色</button>
    </div>
  </header>

  <main class="layout">
    <!-- 上/左：地图 -->
    <section class="card map-card">
      <div id="map"></div>

      <!-- 颜色图例 -->
      <div class="legend">
        <div class="legend-title">风速颜色图例</div>
        <div class="legend-row">
          <span class="legend-color legend-low"></span>
          <span>&lt; 3 m/s（低风）</span>
        </div>
        <div class="legend-row">
          <span class="legend-color legend-mid"></span>
          <span>3 – 7 m/s（中风）</span>
        </div>
        <div class="legend-row">
          <span class="legend-color legend-high"></span>
          <span>≥ 7 m/s（高风）</span>
        </div>
      </div>

      <div class="map-controls">
        <div class="map-controls-row">
          <div class="time-label">
            当前日期：<span id="currentTime">--</span>
            ｜ 风速：<span id="currentSpeed">--</span> m/s
          </div>
          <div class="btn-group">
            <button id="prevBtn">◀ 上一条</button>
            <button id="playPauseBtn" class="primary">▶ 播放</button>
            <button id="nextBtn">下一条 ▶</button>
          </div>
        </div>
        <div class="map-controls-row">
          <div>时间位置：</div>
          <div class="slider-wrap">
            <input
              type="range"
              id="timeSlider"
              min="0"
              max="0"
              value="0"
              step="1"
            />
          </div>
        </div>
        <div class="status">
          坐标：新海浜（35.21622, 136.11864） · 箭头长度 ≈ 风速，方向 ≈ 风向
        </div>
      </div>
    </section>

    <!-- 下/右：表格 -->
    <section class="card">
      <div class="toolbar" style="margin-bottom: 10px">
        <label>搜索</label>
        <input
          id="searchInput"
          type="text"
          placeholder="按任意关键词过滤（全列匹配）"
          style="min-width: 260px"
        />
      </div>
      <div class="table-wrap">
        <table id="data-table">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ========= 基本配置 =========
    const CONFIG = {
      station: {
        name: "Shinhama 风速计（新海浜）",
        lat: 35.21622,
        lng: 136.11864,
      },
      mapCenter: [35.21622, 136.11864],
      mapZoom: 12,
    };

    // ★★ 和 CSV 表头一致 ★★
    const WIND_FIELDS = {
      dir: "WD_AV (deg)",    // 风向列名
      speed: "WS_AV (m/s)",  // 风速列名
    };

    const statusEl = document.getElementById("status");
    const yearSel = document.getElementById("yearSel");
    const monSel = document.getElementById("monSel");
    const searchInput = document.getElementById("searchInput");
    const tableHead = document.getElementById("table-head");
    const tableBody = document.getElementById("table-body");
    const timeSlider = document.getElementById("timeSlider");
    const currentTimeEl = document.getElementById("currentTime");
    const currentSpeedEl = document.getElementById("currentSpeed");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const csvDownload = document.getElementById("csvDownload");

    let rawRows = [];    // 原始 CSV 行
    let animRows = [];   // 用于动画的行
    let animIndex = 0;   // 当前播放到第几条
    let animTimer = null;
    let isPlaying = false;  // 初始为不播放状态
    const ANIM_INTERVAL = 1000; // 每帧间隔（毫秒）

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    // ========= 主题切换 =========
    document.getElementById("themeBtn").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const btn = document.getElementById("themeBtn");
      btn.textContent = document.body.classLis
