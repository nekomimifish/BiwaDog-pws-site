<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title data-i18n="pageTitle">PWS · 新海浜地图 + CSV风速数据</title>

  <!-- Leaflet & PapaParse：从 CDN 加载 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0b1625;
      --muted: #5b6b82;
      --panel: #ffffff;
      --grid: #e5e9f2;
      --header: #f4f6fb;
      --accent: #1677ff;
      --hover: #eef4ff;
    }
    .dark {
      --bg: #0b1016;
      --text: #ecf2ff;
      --muted: #9fb1cc;
      --panel: #101822;
      --grid: #1f2a3a;
      --header: #0f1824;
      --accent: #3aa0ff;
      --hover: #13283f;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Noto Sans JP", "Noto Sans SC", sans-serif;
    }
    header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--grid);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    select, input[type="text"], input[type="range"] {
      padding: 6px 8px;
      border: 1px solid var(--grid);
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
    }
    button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
      font-size: 12px;
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button.ghost { background: transparent; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .csv-link {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      font-size: 12px;
      text-decoration: none;
      cursor: pointer;
    }
    .csv-link:hover { background: var(--hover); }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px;
    }
    /* 默认：上下结构（地图上、表格下） */
    .layout { display: flex; flex-direction: column; gap: 20px; }
    /* 超大屏：宽 >= 2560px 时左右结构 */
    @media (min-width: 2560px) {
      .layout {
        display: grid;
        grid-template-columns: 1.05fr 1.2fr;
        align-items: start;
        gap: 20px;
      }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: 12px;
      padding: 10px;
    }
    .map-card { position: relative; }
    #map {
      height: 60vh;
      min-height: 360px;
      border-radius: 10px;
    }
    .status { font-size: 12px; color: var(--muted); margin-left: 8px; }
    .map-controls { margin-top: 8px; display: flex; flex-direction: column; gap: 6px; font-size: 12px; }
    .map-controls-row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: space-between; }
    .time-label { font-weight: 500; }
    #currentTime, #currentSpeed { font-family: "Consolas", "SF Mono", monospace; }
    .slider-wrap { width: 100%; }
    .slider-wrap input[type="range"] { width: 100%; padding: 0; }
    .table-wrap {
      border: 1px solid var(--grid);
      border-radius: 10px;
      overflow: auto;
      max-height: 70vh;
      background: var(--panel);
    }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    thead { background: var(--header); position: sticky; top: 0; z-index: 1; }
    th, td { border-bottom: 1px solid var(--grid); padding: 6px 8px; text-align: left; white-space: nowrap; }
    tbody tr:nth-child(even) td { background: #f9fbff; }
    tbody tr:hover td { background: var(--hover); }
    .spacer { flex: 1; }

    /* 图例样式 */
    .legend {
      position: absolute;
      right: 14px;
      bottom: 14px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
      border: 1px solid var(--grid);
      padding: 8px 10px;
      font-size: 11px;
      color: #333;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }
    .dark .legend { background: rgba(16, 24, 32, 0.9); color: #e0ecff; }
    .legend-title { font-weight: 600; margin-bottom: 4px; }
    .legend-row { display: flex; align-items: center; gap: 6px; margin: 2px 0; }
    .legend-color {
      width: 14px;
      height: 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
    }
    .legend-low  { background: #2ecc71; border-color: #29b866; }
    .legend-mid  { background: #f1c40f; border-color: #d0a90c; }
    .legend-high { background: #e74c3c; border-color: #c0392b; }
  </style>
</head>

<body>
  <header>
    <h1 data-i18n="title">PWS · 新海浜地图 + CSV风速数据</h1>

    <div class="toolbar">
      <label data-i18n="yearLabel">年份</label>
      <select id="yearSel"></select>

      <label data-i18n="monthLabel">月份</label>
      <select id="monSel"></select>

      <button id="loadBtn" class="primary" data-i18n="loadBtn">加载 ./data/YYYY-MM.csv</button>

      <!-- CSV 下载按钮 -->
      <a id="csvDownload" class="csv-link" href="#" download data-i18n="csvDownload">下载当前 CSV</a>

      <span id="status" class="status"></span>

      <div class="spacer"></div>

      <!-- 语言切换 -->
      <button id="langBtn" class="ghost">日本語</button>

      <!-- 主题切换 -->
      <button id="themeBtn" class="ghost" data-i18n="themeBtn">切换深色/浅色</button>
    </div>
  </header>

  <main class="layout">
    <!-- 上/左：地图 -->
    <section class="card map-card">
      <div id="map"></div>

      <!-- 风速颜色图例 -->
      <div class="legend">
        <div class="legend-title" data-i18n="legendTitle">风速颜色图例</div>
        <div class="legend-row">
          <span class="legend-color legend-low"></span>
          <span data-i18n="legendLow">&lt; 3 m/s（低风）</span>
        </div>
        <div class="legend-row">
          <span class="legend-color legend-mid"></span>
          <span data-i18n="legendMid">3 – 7 m/s（中风）</span>
        </div>
        <div class="legend-row">
          <span class="legend-color legend-high"></span>
          <span data-i18n="legendHigh">≥ 7 m/s（高风）</span>
        </div>
      </div>

      <div class="map-controls">
        <div class="map-controls-row">
          <div class="time-label">
            <span data-i18n="currentDatePrefix">当前日期：</span><span id="currentTime">--</span>
            <span data-i18n="speedPrefix">｜ 风速：</span><span id="currentSpeed">--</span> <span data-i18n="msUnit">m/s</span>
          </div>

          <div class="btn-group">
            <button id="prevBtn" data-i18n="prevBtn">◀ 上一条</button>
            <button id="playPauseBtn" class="primary" data-i18n="playBtn">▶ 播放</button>
            <button id="nextBtn" data-i18n="nextBtn">下一条 ▶</button>
          </div>
        </div>

        <div class="map-controls-row">
          <div data-i18n="timePos">时间位置：</div>
          <div class="slider-wrap">
            <input type="range" id="timeSlider" min="0" max="0" value="0" step="1" />
          </div>
        </div>

        <div class="status">
          <span data-i18n="mapHint">坐标：新海浜（35.21622, 136.11864） · 箭头长度 ≈ 风速，方向 ≈ 风向</span>
        </div>
      </div>
    </section>

    <!-- 下/右：表格 -->
    <section class="card">
      <div class="toolbar" style="margin-bottom: 10px">
        <label data-i18n="searchLabel">搜索</label>
        <input
          id="searchInput"
          type="text"
          placeholder="按任意关键词过滤（全列匹配）"
          style="min-width: 260px"
        />
      </div>

      <div class="table-wrap">
        <table id="data-table">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ========= i18n（中文/日文切换）=========
    const I18N = {
      zh: {
        pageTitle: "PWS · 新海浜地图 + CSV风速数据",
        title: "PWS · 新海浜地图 + CSV风速数据",
        yearLabel: "年份",
        monthLabel: "月份",
        loadBtn: "加载 ./data/YYYY-MM.csv",
        csvDownload: "下载当前 CSV",
        themeBtn: "切换深色/浅色",
        legendTitle: "风速颜色图例",
        legendLow: "< 3 m/s（低风）",
        legendMid: "3 – 7 m/s（中风）",
        legendHigh: "≥ 7 m/s（高风）",
        currentDatePrefix: "当前日期：",
        speedPrefix: "｜ 风速：",
        msUnit: "m/s",
        prevBtn: "◀ 上一条",
        playBtn: "▶ 播放",
        pauseBtn: "⏸ 暂停",
        nextBtn: "下一条 ▶",
        timePos: "时间位置：",
        mapHint: "坐标：新海浜（35.21622, 136.11864） · 箭头长度 ≈ 风速，方向 ≈ 风向",
        searchLabel: "搜索",
        searchPlaceholder: "按任意关键词过滤（全列匹配）",
        langBtnToJa: "日本語",
        langBtnToZh: "中文",
        // status messages
        statusRequest: (path) => `请求 ${path} ...`,
        statusLoaded: (rows, cols) => `加载成功：${rows} 行 · ${cols} 列`,
        statusEmpty: "CSV 为空",
        statusParseFail: (msg) => `解析失败：${msg}`,
        statusLoadFail: (path, msg) => `加载失败：${path}（${msg}）`,
        statusNoAnim: "无可用于动画的数据行",
        statusNoValidWind: "找不到包含有效风向/风速的数据行（请检查列名是否与代码一致）",
        statusAnim: (idx, total, ts) => `动画：${idx} / ${total} · 原始时间 = ${ts}`,
        statusAnimNoTime: (idx, total) => `动画：${idx} / ${total}（找不到时间列）`,
        alertLoadFirst: "请先点击“加载 CSV”按钮",
      },
      ja: {
        pageTitle: "PWS · 新海浜マップ + CSV 風速データ",
        title: "PWS · 新海浜マップ + CSV 風速データ",
        yearLabel: "年",
        monthLabel: "月",
        loadBtn: "読み込み ./data/YYYY-MM.csv",
        csvDownload: "現在の CSV をダウンロード",
        themeBtn: "ダーク/ライト切替",
        legendTitle: "風速カラーレジェンド",
        legendLow: "< 3 m/s（弱風）",
        legendMid: "3 – 7 m/s（中風）",
        legendHigh: "≥ 7 m/s（強風）",
        currentDatePrefix: "日付：",
        speedPrefix: "｜ 風速：",
        msUnit: "m/s",
        prevBtn: "◀ 前へ",
        playBtn: "▶ 再生",
        pauseBtn: "⏸ 一時停止",
        nextBtn: "次へ ▶",
        timePos: "時間位置：",
        mapHint: "座標：新海浜（35.21622, 136.11864） · 矢印の長さ ≈ 風速、向き ≈ 風向",
        searchLabel: "検索",
        searchPlaceholder: "キーワードでフィルタ（全列）",
        langBtnToJa: "日本語",
        langBtnToZh: "中文",
        // status messages
        statusRequest: (path) => `${path} を取得中...`,
        statusLoaded: (rows, cols) => `読み込み成功：${rows} 行 · ${cols} 列`,
        statusEmpty: "CSV が空です",
        statusParseFail: (msg) => `解析失敗：${msg}`,
        statusLoadFail: (path, msg) => `読み込み失敗：${path}（${msg}）`,
        statusNoAnim: "アニメーション用のデータ行がありません",
        statusNoValidWind: "有効な風向/風速の行が見つかりません（列名がコードと一致しているか確認してください）",
        statusAnim: (idx, total, ts) => `アニメ：${idx} / ${total} · 元の時刻 = ${ts}`,
        statusAnimNoTime: (idx, total) => `アニメ：${idx} / ${total}（時刻列が見つかりません）`,
        alertLoadFirst: "先に「CSV 読み込み」を押してください",
      }
    };

    let currentLang = "zh";

    function t(key, ...args) {
      const dict = I18N[currentLang] || I18N.zh;
      const v = dict[key];
      if (typeof v === "function") return v(...args);
      return v != null ? v : (I18N.zh[key] ?? "");
    }

    function applyLang(lang) {
      currentLang = lang;
      const dict = I18N[lang] || I18N.zh;

      // 1) textContent を一括置換（data-i18n）
      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.getAttribute("data-i18n");
        if (dict[key] != null) el.textContent = dict[key];
      });

      // 2) <title> の更新（data-i18n は head 内で NodeList に入るが保険）
      document.title = dict.pageTitle;

      // 3) placeholder
      const si = document.getElementById("searchInput");
      if (si) si.placeholder = dict.searchPlaceholder;

      // 4) 言語ボタン：次に切り替える言語を表示
      const lb = document.getElementById("langBtn");
      if (lb) lb.textContent = (lang === "zh" ? dict.langBtnToJa : dict.langBtnToZh);

      // 5) html lang 属性
      document.documentElement.lang = (lang === "ja" ? "ja" : "zh-CN");

      // 6) 再生/停止ボタンは状態に合わせて更新
      const pp = document.getElementById("playPauseBtn");
      if (pp) pp.textContent = (isPlaying ? dict.pauseBtn : dict.playBtn);
    }

    // ========= 基本配置 =========
    const CONFIG = {
      station: {
        name: "Shinhama 风速计（新海浜）",
        lat: 35.21622,
        lng: 136.11864,
      },
      mapCenter: [35.21622, 136.11864],
      mapZoom: 12,
    };

    // 和 CSV 表头一致
    const WIND_FIELDS = {
      dir: "WD_AV (deg)",    // 风向列名
      speed: "WS_AV (m/s)",  // 风速列名
    };

    const statusEl = document.getElementById("status");
    const yearSel = document.getElementById("yearSel");
    const monSel = document.getElementById("monSel");
    const searchInput = document.getElementById("searchInput");
    const tableHead = document.getElementById("table-head");
    const tableBody = document.getElementById("table-body");
    const timeSlider = document.getElementById("timeSlider");
    const currentTimeEl = document.getElementById("currentTime");
    const currentSpeedEl = document.getElementById("currentSpeed");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const playPauseBtn = document.getElementById("playPauseBtn");
    const csvDownload = document.getElementById("csvDownload");

    let rawRows = [];    // 原始 CSV 行
    let animRows = [];   // 用于动画的行
    let animIndex = 0;   // 当前播放到第几条
    let animTimer = null;
    let isPlaying = false;  // 初始为不播放状态
    const ANIM_INTERVAL = 1000; // 每帧间隔（毫秒）

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    // ========= 语言切换按钮 =========
    document.getElementById("langBtn").addEventListener("click", () => {
      applyLang(currentLang === "zh" ? "ja" : "zh");
      // 语言切换后，顺便刷新一遍状态文本（如果当前有）
      if (statusEl.textContent) setStatus(statusEl.textContent);
    });

    // ========= 主题切换 =========
    document.getElementById("themeBtn").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const btn = document.getElementById("themeBtn");
      // 主题按钮文案由 i18n 控制，所以这里只保留原逻辑（可选）
      btn.textContent = document.body.classList.contains("dark")
        ? (currentLang === "ja" ? "ライトへ" : "切换为浅色")
        : t("themeBtn");
    });

    // ========= 初始化地图 =========
    const map = L.map("map").setView(CONFIG.mapCenter, CONFIG.mapZoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    // 测站点标记
    L.marker([CONFIG.station.lat, CONFIG.station.lng])
      .addTo(map)
      .bindPopup(CONFIG.station.name)
      .openPopup();

    // 箭头图层（只显示一个）
    const arrowLayer = L.layerGroup().addTo(map);

    // ========= 年月下拉 =========
    (function initYM() {
      const now = new Date();
      for (let y = now.getFullYear() - 5; y <= now.getFullYear() + 2; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === now.getFullYear()) opt.selected = true;
        yearSel.appendChild(opt);
      }
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = (m + 1) + (currentLang === "ja" ? "月" : " 月");
        if (m === now.getMonth()) opt.selected = true;
        monSel.appendChild(opt);
      }
    })();

    // ========= 读取 CSV =========
    async function loadCSV() {
      const y = parseInt(yearSel.value, 10);
      const m = parseInt(monSel.value, 10) + 1;
      const ymStr = `${String(y)}-${String(m).padStart(2, "0")}`;
      const path = `./data/${ymStr}.csv`;

      // 更新下载链接：当前选择的年月
      csvDownload.href = path;
      csvDownload.download = `${ymStr}.csv`;
      csvDownload.textContent = (currentLang === "ja" ? `ダウンロード ${ymStr}.csv` : `下载 ${ymStr}.csv`);

      setStatus(t("statusRequest", path));

      try {
        const res = await fetch(`${path}?t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();

        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: (parsed) => {
            const rows = parsed.data || [];
            if (!rows.length) {
              setStatus(t("statusEmpty"));
              rawRows = [];
              renderTable([]);
              stopWindAnimation();
              arrowLayer.clearLayers();
              return;
            }
            rawRows = rows;
            setStatus(t("statusLoaded", rows.length, Object.keys(rows[0]).length));
            renderTable(rows);
            // 初始化动画
            startWindAnimation(rows);
          },
          error: (err) => {
            setStatus(t("statusParseFail", err.message));
          },
        });
      } catch (err) {
        console.error(err);
        setStatus(t("statusLoadFail", path, err.message));
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadCSV);

    // ========= 表格渲染 =========
    function renderTable(rows) {
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";
      if (!rows || !rows.length) return;

      const headers = Object.keys(rows[0]);

      // 表头
      const trHead = document.createElement("tr");
      headers.forEach((h) => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      tableHead.appendChild(trHead);

      // 表身
      rows.forEach((row) => {
        const tr = document.createElement("tr");
        headers.forEach((h) => {
          const td = document.createElement("td");
          const v = row[h];
          td.textContent = v == null ? "" : String(v);
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    // ========= 搜索过滤 =========
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      if (!rawRows.length) return;

      if (!q) {
        renderTable(rawRows);
        startWindAnimation(rawRows);
        return;
      }
      const filtered = rawRows.filter((row) =>
        Object.values(row).some((v) => v != null && String(v).toLowerCase().includes(q))
      );
      renderTable(filtered);
      startWindAnimation(filtered);
    });

    // ========= 动画控制 =========
    function stopWindAnimation() {
      if (animTimer !== null) {
        clearTimeout(animTimer);
        animTimer = null;
      }
    }

    function startWindAnimation(rows) {
      stopWindAnimation();
      arrowLayer.clearLayers();

      if (!rows || !rows.length) {
        setStatus(t("statusNoAnim"));
        animRows = [];
        return;
      }

      const dirKey = WIND_FIELDS.dir;
      const spdKey = WIND_FIELDS.speed;

      // 过滤掉无效风向/风速
      animRows = rows.filter((r) => {
        const d = parseFloat(r[dirKey]);
        const s = parseFloat(r[spdKey]);
        return isFinite(d) && isFinite(s);
      });

      if (!animRows.length) {
        setStatus(t("statusNoValidWind"));
        return;
      }

      animIndex = 0;
      timeSlider.min = 0;
      timeSlider.max = animRows.length - 1;
      timeSlider.value = 0;
      timeSlider.step = 1;

      // 先画出第 1 帧
      drawSingleArrow(animRows[0]);
      updateTimeUI(animRows[0], 0);

      // 初始化后保持“暂停”
      stopWindAnimation();
      isPlaying = false;
      playPauseBtn.textContent = t("playBtn");
    }

    function stepWindAnimation() {
      if (!animRows.length) return;

      const row = animRows[animIndex];
      drawSingleArrow(row);
      updateTimeUI(row, animIndex);

      animIndex = (animIndex + 1) % animRows.length;

      if (isPlaying) {
        animTimer = setTimeout(stepWindAnimation, ANIM_INTERVAL);
      }
    }

    // 更新“日期 + 风速”显示 & 滑块
    function updateTimeUI(row, idx) {
      // 找时间字段（优先 Timestamp）
      const keys = Object.keys(row);
      const tsKey =
        keys.find((k) => /timestamp/i.test(k)) ||
        keys.find((k) => /time/i.test(k)) ||
        keys.find((k) => /date/i.test(k));

      const spdKey = WIND_FIELDS.speed;
      const speedVal = row[spdKey];

      // 日期处理：只显示 年/月/日
      if (tsKey) {
        const tsRaw = row[tsKey];              // 如 "2025/10/01 00:10:00.425"
        let dateStr = String(tsRaw);
        const datePart = dateStr.split(/[ T]/)[0];  // "2025/10/01"
        currentTimeEl.textContent = datePart;

        setStatus(t("statusAnim", idx + 1, animRows.length, tsRaw));
      } else {
        currentTimeEl.textContent = "--";
        setStatus(t("statusAnimNoTime", idx + 1, animRows.length));
      }

      // 风速显示：保留 1 位小数
      if (currentSpeedEl) {
        const num = parseFloat(speedVal);
        currentSpeedEl.textContent = isFinite(num) ? num.toFixed(1) : "--";
      }

      // 进度条位置
      timeSlider.value = idx;
    }

    // ========= 时间控制 UI：滑块 & 按钮 =========
    timeSlider.addEventListener("input", () => {
      if (!animRows.length) return;
      const idx = parseInt(timeSlider.value, 10);
      animIndex = idx;
      const row = animRows[idx];
      drawSingleArrow(row);
      updateTimeUI(row, idx);
      // 手动拖动时暂停播放
      stopWindAnimation();
      isPlaying = false;
      playPauseBtn.textContent = t("playBtn");
    });

    prevBtn.addEventListener("click", () => {
      if (!animRows.length) {
        if (rawRows.length) startWindAnimation(rawRows);
        else { alert(t("alertLoadFirst")); return; }
      }
      stopWindAnimation();
      isPlaying = false;
      playPauseBtn.textContent = t("playBtn");
      animIndex = (animIndex - 1 + animRows.length) % animRows.length;
      const row = animRows[animIndex];
      drawSingleArrow(row);
      updateTimeUI(row, animIndex);
    });

    nextBtn.addEventListener("click", () => {
      if (!animRows.length) {
        if (rawRows.length) startWindAnimation(rawRows);
        else { alert(t("alertLoadFirst")); return; }
      }
      stopWindAnimation();
      isPlaying = false;
      playPauseBtn.textContent = t("playBtn");
      animIndex = (animIndex + 1) % animRows.length;
      const row = animRows[animIndex];
      drawSingleArrow(row);
      updateTimeUI(row, animIndex);
    });

    playPauseBtn.addEventListener("click", () => {
      // 兜底：如果动画数组还没准备好，但原始数据有，就在这里初始化
      if (!animRows.length) {
        if (rawRows.length) startWindAnimation(rawRows);
        else { alert(t("alertLoadFirst")); return; }
      }

      if (isPlaying) {
        stopWindAnimation();
        isPlaying = false;
        playPauseBtn.textContent = t("playBtn");
      } else {
        isPlaying = true;
        playPauseBtn.textContent = t("pauseBtn");
        stepWindAnimation();
      }
    });

    // ========= 画单个箭头（粗线 + 三角形尖端） =========
    function drawSingleArrow(row) {
      const dirKey = WIND_FIELDS.dir;
      const spdKey = WIND_FIELDS.speed;

      const dirDeg = parseFloat(row[dirKey]); // 风向（度）
      const speed  = parseFloat(row[spdKey]); // 风速（m/s）

      if (!isFinite(dirDeg) || !isFinite(speed)) return;

      arrowLayer.clearLayers();

      const baseLat = CONFIG.station.lat;
      const baseLng = CONFIG.station.lng;

      // 风速决定颜色
      let color;
      if (speed < 3) color = "#2ecc71";       // 低风速：绿
      else if (speed < 7) color = "#f1c40f";  // 中风：黄
      else color = "#e74c3c";                 // 高风：红

      // 风速决定粗细
      const lineWidth = Math.min(14, 6 + speed);

      // 风速决定长度（km）
      const lenKm = Math.max(0.4, speed * 0.5);

      // 角度换算（Leaflet: 0° 指向东，我们用 dirDeg-90° 的定义）
      const rad = ((dirDeg - 90) * Math.PI) / 180;

      function offsetLatLng(latDeg, lngDeg, distKm, bearingRad) {
        const dLat = (distKm * Math.sin(bearingRad)) / 111;
        const dLng =
          (distKm * Math.cos(bearingRad)) /
          (111 * Math.cos((latDeg * Math.PI) / 180));
        return L.latLng(latDeg + dLat, lngDeg + dLng);
      }

      const start = L.latLng(baseLat, baseLng);
      const end   = offsetLatLng(baseLat, baseLng, lenKm, rad);

      L.circleMarker(start, {
        radius: 5,
        color: color,
        fillColor: color,
        fillOpacity: 1,
        weight: 2,
      }).addTo(arrowLayer);

      L.polyline([start, end], {
        weight: lineWidth,
        color: color,
        opacity: 1,
        lineCap: "round",
      }).addTo(arrowLayer);

      const tipLenKm = Math.max(0.2, lenKm * 0.25);
      const tipAngle = 20 * Math.PI / 180;

      const backLeftBearing  = rad + Math.PI + tipAngle;
      const backRightBearing = rad + Math.PI - tipAngle;

      const leftPoint  = offsetLatLng(end.lat, end.lng, tipLenKm, backLeftBearing);
      const rightPoint = offsetLatLng(end.lat, end.lng, tipLenKm, backRightBearing);

      L.polygon([end, leftPoint, rightPoint], {
        color: color,
        fillColor: color,
        fillOpacity: 1,
        weight: 0,
      }).addTo(arrowLayer);
    }

    // ========= 初期言語設定 =========
    applyLang("zh");
  </script>
</body>
</html>
