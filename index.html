<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWS · 新海浜地图 + CSV表格 + 风速/风向箭头</title>

  <!-- Leaflet & PapaParse：从 CDN 加载 -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #ffffff;
      --text: #0b1625;
      --muted: #5b6b82;
      --panel: #ffffff;
      --grid: #e5e9f2;
      --header: #f4f6fb;
      --accent: #1677ff;
      --hover: #eef4ff;
    }
    .dark {
      --bg: #0b1016;
      --text: #ecf2ff;
      --muted: #9fb1cc;
      --panel: #101822;
      --grid: #1f2a3a;
      --header: #0f1824;
      --accent: #3aa0ff;
      --hover: #13283f;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue",
        Arial, "Noto Sans JP", "Noto Sans SC", sans-serif;
    }
    header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--grid);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      background: var(--panel);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    select,
    input[type="text"] {
      padding: 8px 10px;
      border: 1px solid var(--grid);
      border-radius: 8px;
      background: var(--panel);
      color: var(--text);
    }
    button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--grid);
      background: var(--panel);
      color: var(--text);
      cursor: pointer;
    }
    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #fff;
    }
    button.ghost {
      background: transparent;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px;
    }
    /* 默认：上下结构（地图上、表格下） */
    .layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    /* 超大屏：宽 >= 2560px 时左右结构 */
    @media (min-width: 2560px) {
      .layout {
        display: grid;
        grid-template-columns: 1.05fr 1.2fr;
        align-items: start;
        gap: 20px;
      }
    }
    .card {
      background: var(--panel);
      border: 1px solid var(--grid);
      border-radius: 12px;
      padding: 10px;
    }
    #map {
      height: 60vh;
      min-height: 360px;
      border-radius: 10px;
    }
    .status {
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
    }
    .table-wrap {
      border: 1px solid var(--grid);
      border-radius: 10px;
      overflow: auto;
      max-height: 70vh;
      background: var(--panel);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    thead {
      background: var(--header);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th,
    td {
      border-bottom: 1px solid var(--grid);
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    tbody tr:nth-child(even) td {
      background: #f9fbff;
    }
    tbody tr:hover td {
      background: var(--hover);
    }
    .spacer {
      flex: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1>PWS · 新海浜地图 + CSV风速数据</h1>
    <div class="toolbar">
      <label>年份</label>
      <select id="yearSel"></select>
      <label>月份</label>
      <select id="monSel"></select>
      <button id="loadBtn" class="primary">加载 ./data/YYYY-MM.csv</button>
      <span id="status" class="status"></span>
      <div class="spacer"></div>
      <button id="themeBtn" class="ghost">切换深色/浅色</button>
    </div>
  </header>

  <main class="layout">
    <!-- 上/左：地图 -->
    <section class="card">
      <div id="map"></div>
      <div class="status">
        坐标：新海浜（35.21622, 136.11864） · 箭头长度 ≈ 风速，方向 ≈ 风向
      </div>
    </section>

    <!-- 下/右：表格 -->
    <section class="card">
      <div class="toolbar" style="margin-bottom: 10px">
        <label>搜索</label>
        <input
          id="searchInput"
          type="text"
          placeholder="按任意关键词过滤（全列匹配）"
          style="min-width: 260px"
        />
      </div>
      <div class="table-wrap">
        <table id="data-table">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ========= 基本配置 =========
    const CONFIG = {
      station: {
        name: "Shinhama 风速计（新海浜）",
        lat: 35.21622,
        lng: 136.11864,
      },
      mapCenter: [35.21622, 136.11864],
      mapZoom: 12,
    };

    // 你的 2025-10.csv 表头里的风向/风速列名（带空格）
    const WIND_FIELDS = {
      dir: "WD_AV (deg)",    // 风向列名
      speed: "WS_AV (m/s)",  // 风速列名
    };

    const statusEl = document.getElementById("status");
    const yearSel = document.getElementById("yearSel");
    const monSel = document.getElementById("monSel");
    const searchInput = document.getElementById("searchInput");
    const tableHead = document.getElementById("table-head");
    const tableBody = document.getElementById("table-body");

    let rawRows = [];    // 原始 CSV 行（对象数组）
    let animRows = [];   // 用于动画的行
    let animIndex = 0;   // 当前播放到第几条
    let animTimer = null;
    const ANIM_INTERVAL = 1000; // 每帧间隔（毫秒），1000=1秒

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    // ========= 主题切换 =========
    document.getElementById("themeBtn").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      const btn = document.getElementById("themeBtn");
      btn.textContent = document.body.classList.contains("dark")
        ? "切换为浅色"
        : "切换深色/浅色";
    });

    // ========= 初始化地图 =========
    const map = L.map("map").setView(CONFIG.mapCenter, CONFIG.mapZoom);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap",
    }).addTo(map);

    // 测站点
    L.marker([CONFIG.station.lat, CONFIG.station.lng])
      .addTo(map)
      .bindPopup(CONFIG.station.name)
      .openPopup();

    // 箭头图层（只显示一个箭头）
    const arrowLayer = L.layerGroup().addTo(map);

    // ========= 年月下拉 =========
    (function initYM() {
      const now = new Date();
      for (let y = now.getFullYear() - 5; y <= now.getFullYear() + 2; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        if (y === now.getFullYear()) opt.selected = true;
        yearSel.appendChild(opt);
      }
      for (let m = 0; m < 12; m++) {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m + 1 + " 月";
        if (m === now.getMonth()) opt.selected = true;
        monSel.appendChild(opt);
      }
    })();

    // ========= 读取 CSV =========
    async function loadCSV() {
      const y = parseInt(yearSel.value, 10);
      const m = parseInt(monSel.value, 10) + 1;
      const path = `./data/${String(y)}-${String(m).padStart(2, "0")}.csv`;

      setStatus(`请求 ${path} ...`);

      try {
        const res = await fetch(`${path}?t=${Date.now()}`, { cache: "no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();

        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          dynamicTyping: false,
          complete: (parsed) => {
            const rows = parsed.data || [];
            if (!rows.length) {
              setStatus("CSV 为空");
              rawRows = [];
              renderTable([]);
              stopWindAnimation();
              arrowLayer.clearLayers();
              return;
            }
            rawRows = rows;
            setStatus(`加载成功：${rows.length} 行 · ${Object.keys(rows[0]).length} 列`);
            renderTable(rows);
            startWindAnimation(rows);   // 加载完成后启动动画
          },
          error: (err) => {
            setStatus("解析失败：" + err.message);
          },
        });
      } catch (err) {
        console.error(err);
        setStatus(`加载失败：${path}（${err.message}）`);
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadCSV);

    // ========= 表格渲染 =========
    function renderTable(rows) {
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      if (!rows || !rows.length) return;

      const headers = Object.keys(rows[0]);

      // 表头
      const trHead = document.createElement("tr");
      headers.forEach((h) => {
        const th = document.createElement("th");
        th.textContent = h;
        trHead.appendChild(th);
      });
      tableHead.appendChild(trHead);

      // 表身
      rows.forEach((row) => {
        const tr = document.createElement("tr");
        headers.forEach((h) => {
          const td = document.createElement("td");
          const v = row[h];
          td.textContent = v == null ? "" : String(v);
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    // 简单搜索：全列模糊匹配 + 动画基于过滤结果
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.trim().toLowerCase();
      if (!rawRows.length) return;

      if (!q) {
        renderTable(rawRows);
        startWindAnimation(rawRows);
        return;
      }
      const filtered = rawRows.filter((row) =>
        Object.values(row).some(
          (v) => v != null && String(v).toLowerCase().includes(q)
        )
      );
      renderTable(filtered);
      startWindAnimation(filtered);
    });

    // ========= 动画相关：只显示 1 个箭头，按时间循环播放 =========

    function stopWindAnimation() {
      if (animTimer !== null) {
        clearTimeout(animTimer);
        animTimer = null;
      }
    }

    function startWindAnimation(rows) {
      stopWindAnimation();
      arrowLayer.clearLayers();

      if (!rows || !rows.length) {
        setStatus("无可用于动画的数据行");
        animRows = [];
        return;
      }

      const dirKey = WIND_FIELDS.dir;
      const spdKey = WIND_FIELDS.speed;

      // 过滤掉无效风向/风速
      animRows = rows.filter((r) => {
        const d = parseFloat(r[dirKey]);
        const s = parseFloat(r[spdKey]);
        return isFinite(d) && isFinite(s);
      });

      if (!animRows.length) {
        setStatus("找不到包含有效风向/风速的数据行");
        return;
      }

      animIndex = 0;
      stepWindAnimation();  // 立刻播放第一帧
    }

    function stepWindAnimation() {
      if (!animRows.length) return;

      const row = animRows[animIndex];
      drawSingleArrow(row);

      // 状态栏显示当前时间（如果有 Timestamp 字段）
      const tsKey = Object.keys(row).find((k) =>
        k.toLowerCase().includes("timestamp")
      );
      if (tsKey) {
        setStatus(
          `动画播放中：${animIndex + 1} / ${animRows.length} · 时间 = ${row[tsKey]}`
        );
      } else {
        setStatus(
          `动画播放中：${animIndex + 1} / ${animRows.length}`
        );
      }

      animIndex = (animIndex + 1) % animRows.length;
      animTimer = setTimeout(stepWindAnimation, ANIM_INTERVAL);
    }

function drawSingleArrow(row) {
  const dirKey = WIND_FIELDS.dir;
  const spdKey = WIND_FIELDS.speed;

  const dirDeg = parseFloat(row[dirKey]); // 风向（度）
  const speed  = parseFloat(row[spdKey]); // 风速（m/s）

  if (!isFinite(dirDeg) || !isFinite(speed)) return;

  // 每一帧只画一个箭头，先清空
  arrowLayer.clearLayers();

  const baseLat = CONFIG.station.lat;
  const baseLng = CONFIG.station.lng;

  // ===== 1. 用风速决定箭头颜色 =====
  // 小风：绿色，中等：黄色，大风：红色
  let color;
  if (speed < 3) {
    color = "#2ecc71";   // 绿
  } else if (speed < 7) {
    color = "#f1c40f";   // 黄
  } else {
    color = "#e74c3c";   // 红
  }

  // ===== 2. 用风速决定箭头粗细 =====
  let weight;
  if (speed < 3) {
    weight = 4;
  } else if (speed < 7) {
    weight = 6;
  } else {
    weight = 8;
  }

  // ===== 3. 用风速决定箭头长度（比之前更长、更显眼）=====
  const lenKm = Math.max(0.3, speed * 0.35);

  // 将气象角度近似为“箭头指向的方向”
  const rad = ((dirDeg - 90) * Math.PI) / 180;

  const dLat =
    (lenKm * Math.sin(rad)) / 111; // 1°纬度 ≈ 111km
  const dLng =
    (lenKm * Math.cos(rad)) /
    (111 * Math.cos((baseLat * Math.PI) / 180));

  const startLat = baseLat;
  const startLng = baseLng;
  const endLat   = baseLat + dLat;
  const endLng   = baseLng + dLng;

  // 底部做一个小圆点，更显眼
  L.circleMarker([startLat, startLng], {
    radius: 4,
    color: color,
    fillColor: color,
    fillOpacity: 0.9,
    weight: 2,
  }).addTo(arrowLayer);

  // 画粗箭头线
  L.polyline(
    [
      [startLat, startLng],
      [endLat, endLng],
    ],
    {
      weight: weight,
      color: color,
      opacity: 0.95,
      lineCap: "round",
    }
  ).addTo(arrowLayer);
}

  </script>
</body>
</html>
