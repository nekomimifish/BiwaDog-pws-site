<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PWS 地图 + Excel表格（新海浜坐标版）</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#ffffff; --text:#0b1625; --muted:#5b6b82; --panel:#ffffff;
      --grid:#e5e9f2; --header:#f4f6fb; --accent:#1677ff; --hover:#eef4ff; --sticky:#f8fbff;
    }
    .dark{
      --bg:#0b1016; --text:#ecf2ff; --muted:#9fb1cc; --panel:#101822;
      --grid:#1f2a3a; --header:#0f1824; --accent:#3aa0ff; --hover:#13283f; --sticky:#112033;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP","Noto Sans SC"}
    header{padding:12px 14px;border-bottom:1px solid var(--grid);display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--panel);position:sticky;top:0;z-index:10}
    header h1{margin:0;font-size:18px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select, input[type="number"], input[type="text"]{padding:8px 10px;border:1px solid var(--grid);border-radius:8px;background:var(--panel);color:var(--text)}
    button{padding:8px 12px;border-radius:8px;border:1px solid var(--grid);background:var(--panel);color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button.ghost{background:transparent}
    main{max-width:1400px;margin:0 auto;padding:14px}
    .layout{display:grid;grid-template-columns: 1fr 1.2fr;gap:14px}
    @media (max-width: 1100px){ .layout{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--grid);border-radius:12px;padding:10px}
    #map{height:62vh;min-height:360px;border-radius:10px}
    .status{font-size:12px;color:var(--muted);margin-left:8px}
    /* 表格样式（Excel风格） */
    .table-wrap{border:1px solid var(--grid);border-radius:10px;overflow:auto;max-height:72vh;background:var(--panel)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
    thead th{position:sticky;top:0;background:var(--header);z-index:2;border-bottom:1px solid var(--grid);text-align:left;padding:10px;white-space:nowrap}
    thead th.sortable{cursor:pointer}
    thead th .arrow{margin-left:6px;opacity:.65}
    tbody td{border-bottom:1px solid var(--grid);border-right:1px solid var(--grid);padding:8px;vertical-align:top;background:var(--panel)}
    tbody tr:hover td{background:var(--hover)}
    thead th.sticky-first, tbody td.sticky-first{position:sticky;left:0;z-index:1;background:var(--sticky);border-right:1px solid var(--grid)}
    thead th.sticky-first{z-index:3}
    .pill{font-size:12px;color:var(--muted);padding:4px 8px;border:1px solid var(--grid);border-radius:999px}
    .spacer{flex:1}
  </style>
</head>
<body>
  <header>
    <h1>PWS 地图 + Excel表格（新海浜坐标版）</h1>
    <div class="toolbar">
      <label>年份</label><select id="yearSel"></select>
      <label>月份</label><select id="monSel"></select>
      <button id="loadBtn" class="primary">加载 ./data/YYYY-MM.csv</button>
      <span id="status" class="status"></span>
      <div class="spacer"></div>
      <button id="themeBtn" class="ghost">切换深色/浅色</button>
    </div>
  </header>

  <main class="layout">
    <!-- 左：地图 -->
    <section class="card">
      <div id="map"></div>
      <div class="status" id="mapNote">提示：地图使用 Leaflet，标注为你提供的新海浜风速计位置</div>
    </section>

    <!-- 右：Excel 风格表格 + 工具条 -->
    <section>
      <div class="card toolbar" style="margin-bottom:10px">
        <label>搜索</label><input id="searchInput" type="text" placeholder="按任意关键词过滤（支持多列）" style="min-width:280px">
        <label>每页</label><input id="pageSize" type="number" value="200" min="50" max="2000" step="50" style="width:90px">
        <button id="exportBtn">导出当前筛选为 CSV</button>
        <span id="meta" class="pill"></span>
      </div>
      <div class="table-wrap card">
        <table id="grid">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card toolbar" style="justify-content:space-between;margin-top:10px">
        <div><button id="prevBtn">上一页</button> <button id="nextBtn">下一页</button></div>
        <div class="pill" id="pageInfo">第 0 / 0 页</div>
      </div>
    </section>
  </main>

  <script>
    // ======= 配置：使用你提供的真实坐标 =======
    const CONFIG = {
      station: { name:'Shinhama 风速计（新海浜）', lat:35.21622, lng:136.11864 },
      mapCenter: [35.21622, 136.11864],
      mapZoom: 12
    };

    // ======= 风向 / 风速列名（请按你的 CSV 表头调整） =======
    const WIND_FIELDS = {
      dir: 'WD_AV(deg)',    // 风向列名，例如 WD_AV(deg)、WD 等
      speed: 'WS_AV(m/s)'   // 风速列名，例如 WS_AV(m/s)、WS 等
    };

    // 所有风向箭头绘制在同一个图层，方便清除和重绘
    const arrowLayer = L.layerGroup();

    // ======= 主题切换（默认浅色） =======
    const themeBtn = document.getElementById('themeBtn');
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      themeBtn.textContent = document.body.classList.contains('dark') ? '切换为浅色' : '切换深色/浅色';
    });

    // ======= Leaflet 地图 =======
    const map = L.map('map').setView(CONFIG.mapCenter, CONFIG.mapZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    const marker = L.marker([CONFIG.station.lat, CONFIG.station.lng]).addTo(map).bindPopup(CONFIG.station.name);

    // ======= 年月选择 =======
    const yearSel = document.getElementById('yearSel');
    const monSel = document.getElementById('monSel');
    (function initYM(){
      const now = new Date();
      for(let y=now.getFullYear()-5; y<=now.getFullYear()+2; y++){
        const o = document.createElement('option'); o.value=y; o.textContent=y; if(y===now.getFullYear()) o.selected=true; yearSel.appendChild(o);
      }
      for(let m=0; m<12; m++){
        const o = document.createElement('option'); o.value=m; o.textContent=(m+1)+' 月'; if(m===now.getMonth()) o.selected=true; monSel.appendChild(o);
      }
    })();

    // ======= 状态与工具 =======
    const statusEl = document.getElementById('status');
    const $ = s => document.querySelector(s);
    const pad2 = n => String(n).padStart(2,'0');
    function setStatus(t){ statusEl.textContent = t || ''; }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function toCSV(rows){ return rows.map(r => r.map(cell => {
      const str = (cell==null)?'':String(cell);
      return /[",\n]/.test(str) ? '"'+str.replace(/"/g,'""')+'"' : str;
    }).join(',')).join('\n'); }

    // ======= 表格数据状态 =======
    let headers = [];
    let dataRows = [];
    let filteredRows = [];
    let sortInfo = { index:-1, dir:1 };
    let page = 1;
    let pageSize = 200;

    // ======= 渲染表格 =======
    function renderTable(){
      const thead = document.querySelector('#grid thead');
      const tbody = document.querySelector('#grid tbody');
      thead.innerHTML = '<tr>' + headers.map((h,i) => {
        const arrow = (sortInfo.index===i) ? (sortInfo.dir>0?'▲':'▼') : '';
        return `<th class="${i===0?'sticky-first ':''}sortable" data-idx="${i}">${escapeHTML(h)} <span class="arrow">${arrow}</span></th>`;
      }).join('') + '</tr>';
      thead.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const i = parseInt(th.dataset.idx,10);
          if(sortInfo.index===i){ sortInfo.dir*=-1; } else { sortInfo.index=i; sortInfo.dir=1; }
          sortRows(); page=1; renderTable(); renderBody();
        });
      });
      renderBody();
    }
    function renderBody(){
      const tbody = document.querySelector('#grid tbody');
      pageSize = parseInt(document.getElementById('pageSize').value,10) || 200;
      const total = filteredRows.length;
      const totalPages = Math.max(1, Math.ceil(total / pageSize));
      if(page>totalPages) page = totalPages;
      const start = (page-1)*pageSize;
      const slice = filteredRows.slice(start, start+pageSize);
      tbody.innerHTML = slice.map(row => '<tr>' + row.map((cell,i)=>`<td class="${i===0?'sticky-first':''}">${escapeHTML(cell==null?'':cell)}</td>`).join('') + '</tr>').join('');
      document.getElementById('pageInfo').textContent = `第 ${page} / ${totalPages} 页（共 ${total.toLocaleString()} 行，当前每页 ${pageSize} 行）`;
      document.getElementById('meta').textContent = `已加载 ${total.toLocaleString()} 行 | 列数 ${headers.length}`;
    }
    function applyFilter(){
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      filteredRows = !q ? dataRows :
        dataRows.filter(r => r.some(v => (v!=null) && String(v).toLowerCase().includes(q)));
      sortRows(); page=1; renderTable();
    }
    function sortRows(){
      if(sortInfo.index<0) return;
      const i = sortInfo.index, d = sortInfo.dir;
      filteredRows.sort((a,b)=>{
        const A = a[i]==null ? '' : a[i];
        const B = b[i]==null ? '' : b[i];
        const nA = parseFloat(A), nB = parseFloat(B);
        const bothNum = isFinite(nA) && isFinite(nB);
        if(bothNum) return (nA - nB) * d;
        return String(A).localeCompare(String(B)) * d;
      });
    }
    document.getElementById('searchInput').addEventListener('input', ()=>{ clearTimeout(window._t); window._t=setTimeout(applyFilter,150); });
    document.getElementById('pageSize').addEventListener('change', ()=>{ page=1; renderBody(); });
    document.getElementById('prevBtn').addEventListener('click', ()=>{ if(page>1){ page--; renderBody(); } });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ const totalPages=Math.max(1,Math.ceil(filteredRows.length/pageSize)); if(page<totalPages){ page++; renderBody(); } });

    // ======= 导出当前筛选 =======
    document.getElementById('exportBtn').addEventListener('click', () => {
      const csv = toCSV([headers, ...filteredRows]);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='filtered.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ======= 加载 CSV（相对路径 & 防缓存） =======
    
    // ======= 根据 CSV 数据在地图上绘制风向 / 风速箭头 =======
    function updateWindArrows(rows){
      arrowLayer.clearLayers();
      if(!rows || !rows.length){
        return;
      }
      const dirKey = WIND_FIELDS.dir;
      const spdKey = WIND_FIELDS.speed;

      if(!(dirKey in rows[0]) || !(spdKey in rows[0])){
        console.warn('找不到风向/风速列，请检查 WIND_FIELDS 设置是否和 CSV 表头一致');
        return;
      }

      const baseLat = CONFIG.station.lat;
      const baseLng = CONFIG.station.lng;
      const maxArrows = Math.min(12, rows.length);
      const subset = rows.slice(-maxArrows); // 最近几条数据

      subset.forEach((row, idx) => {
        const dirDeg = parseFloat(row[dirKey]);
        const speed  = parseFloat(row[spdKey]);
        if(!isFinite(dirDeg) || !isFinite(speed)) return;

        // 简单把风速映射为箭头长度（单位约 km，系数可根据视觉效果调整）
        const lenKm = Math.max(0.2, speed * 0.15);

        // 把气象角度（来向）简单当成去向使用；如需严格转换可再微调
        const rad = (dirDeg - 90) * Math.PI / 180;

        const dLat = (lenKm * Math.sin(rad)) / 111; // 1°纬度 ≈ 111 km
        const dLng = (lenKm * Math.cos(rad)) / (111 * Math.cos(baseLat * Math.PI/180));

        const startLat = baseLat;
        const startLng = baseLng;
        const endLat   = baseLat + dLat;
        const endLng   = baseLng + dLng;

        const line = L.polyline([[startLat, startLng], [endLat, endLng]], {weight: 2});
        line.addTo(arrowLayer);
      });
    }

async function loadCSV(){
      const y = parseInt(yearSel.value,10);
      const m = parseInt(monSel.value,10)+1;
      const path = `./data/${String(y)}-${String(m).padStart(2,'0')}.csv`;
      setStatus(`请求 ${path} ...`);
      try{
        const res = await fetch(`${path}?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status} - ${path}`);
        const text = await res.text();
        Papa.parse(text, {
          header:true, skipEmptyLines:true, dynamicTyping:false,
          complete: (parsed)=>{
            const rows = parsed.data || [];
            if(!rows.length){ setStatus('CSV 为空'); return; }
            headers = Object.keys(rows[0]);
            dataRows = rows.map(r => headers.map(h => r[h]));
            filteredRows = dataRows.slice();
            sortInfo = { index:-1, dir:1 };
            page = 1;
            setStatus(`加载成功：${rows.length} 行 · ${headers.length} 列`);
            renderTable();
            try {
              updateWindArrows(rows);
            } catch(e) {
              console.error('绘制风向箭头时出错', e);
            }
          },
          error: (err)=> setStatus('解析失败：'+err.message)
        });
      }catch(err){
        console.error(err);
        setStatus(`加载失败：${err.message}（请确认该文件已上传且同源）`);
      }
    }
    document.getElementById('loadBtn').addEventListener('click', loadCSV);
  </script>

  <!-- 右侧工具条 & 表格容器（与脚本中的选择器匹配） -->
  <div style="position:fixed;left:-9999px;top:-9999px" aria-hidden="true">
    <input id="searchInput" />
    <input id="pageSize" />
    <div id="pageInfo"></div>
    <div id="meta"></div>
    <table id="grid"><thead></thead><tbody></tbody></table>
  </div>
</body>
</html>
