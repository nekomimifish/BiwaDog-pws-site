<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wind Arrows（相对路径修正版）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>#map{height:62vh;border:1px solid #1e2a3b;border-radius:12px}</style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
</head>
<body>
  <h1>风向风速箭头（相对路径版）</h1>
  <div>
    <select id="yearSel"></select>
    <select id="monSel"></select>
    <button id="loadBtn">加载 ./data/YYYY-MM.csv</button>
    <span id="status"></span>
  </div>
  <div id="map"></div>
  <script>
    const map = L.map('map').setView([35.215,135.97],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'&copy; OpenStreetMap'}).addTo(map);
    const station = {name:'Shinhama', lat:35.2115, lng:135.9770};
    let marker = L.marker([station.lat, station.lng]).addTo(map).bindTooltip(station.name);

    const now = new Date(); const yearSel=document.getElementById('yearSel'); const monSel=document.getElementById('monSel'); const statusEl=document.getElementById('status');
    function pad2(n){return String(n).padStart(2,'0')}
    for(let y=now.getFullYear()-5;y<=now.getFullYear()+2;y++){const o=document.createElement('option');o.value=y;o.textContent=y;if(y===now.getFullYear())o.selected=true;yearSel.appendChild(o);}
    for(let m=0;m<12;m++){const o=document.createElement('option');o.value=m;o.textContent=(m+1)+' 月';if(m===now.getMonth())o.selected=true;monSel.appendChild(o);}

    function bearingToCanvasAngleDeg(b){return 90 - b}
    function arrowIcon(ws, wd){
      const to = (wd + 180) % 360;
      const ang = bearingToCanvasAngleDeg(to);
      const pxPerMs = 8, minLen=10, maxLen=120;
      let Lpx = Math.min(Math.max(ws*pxPerMs, minLen), maxLen);
      const head=8, W=Lpx+head+6, H=Lpx+head+6, cx=W/2, cy=H/2, y2=cy-Lpx, y1=cy;
      const svg = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}"><line x1="${cx}" y1="${y1}" x2="${cx}" y2="${y2}" stroke="#fff" stroke-width="2" stroke-linecap="round"/><polygon points="${cx},${y2} ${cx-6},${y2+8} ${cx+6},${y2+8}" fill="#fff"/></svg>`;
      return L.divIcon({ html:`<div style="transform:rotate(${ang}deg);transform-origin:center">${svg}</div>`, className:'wind-arrow', iconSize:[W,H], iconAnchor:[W/2,H/2]});
    }

    let rows=[]; let idx=0;
    async function loadMonth(){
      const y = parseInt(yearSel.value,10);
      const m = parseInt(monSel.value,10)+1;
      const path = `./data/${y}-${pad2(m)}.csv`; // ★ 相对路径
      statusEl.textContent = `请求 ${path} ...`;
      try{
        const res = await fetch(`${path}?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error(`HTTP ${res.status} - ${path}`);
        const text = await res.text();
        Papa.parse(text, {header:true, skipEmptyLines:true, complete:(p)=>{
          rows = p.data || [];
          if(!rows.length){ statusEl.textContent='CSV 为空'; return; }
          idx = 0;
          // 取第一行的 WD / WS 字段名（或按你的列名修改）
          const WD = 'WD_AV(deg)'; const WS = 'WS_AV(m/s)';
          const wd = parseFloat(rows[idx][WD]); const ws = parseFloat(rows[idx][WS]);
          marker.setIcon(arrowIcon(isFinite(ws)?ws:0, isFinite(wd)?wd:0));
          statusEl.textContent = `加载成功：${rows.length} 条记录`;
        }});
      }catch(err){
        statusEl.textContent = `加载失败：${err.message}（请确认该文件已上传且同源）`;
      }
    }
    document.getElementById('loadBtn').addEventListener('click', loadMonth);
  </script>
</body>
</html>
